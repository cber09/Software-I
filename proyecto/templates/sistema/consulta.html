<!DOCTYPE html>
{% extends "sistema/layout-sistema.html" %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta</title>
    <script src=""></script>
</head>

<body>
   

    {% block content %}
     <style>
        a {
            text-decoration: none !important;
            color: white;
        }

    </style>
    {%if session.nombrerol == "Administrador"%}
    <div class="top-bar"><i class="fas fa-bars menu"></i><label class="titulo-logo">Buen Productor > Mis
            Consultas</label>
    </div>
    <div class="" style="padding: 20px;">

        <div class="card overflow-scroll" style="background-color: white; border-radius: 3px; height: 85vh;" id="lista">

            <!-- /.card-header -->
            <div class="card-body ">
                <table class="table table-striped" id="consultas">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 250px">Id Consulta</th>
                            <th>Paciente</th>
                            <th>Hora</th>
                            <th style="width: 40px">Estado</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {%for list in consultas%}

                        <tr>
                            <td>{{list.Id_Consulta}}</td>
                            <td>{{list.Nombre}}</td>
                            <td>
                                {{list.Hora}}

                            </td>
                            <td>
                                <span class="badge bg-warning">{{list.NombreEstado}}</span>
                            </td>
                            <td style="text-align: end;"><button type="button" name="detalle" style="border: none;"
                                    value="{{list.Id_Consulta}}" class="btn btn-outline-secondary"><i
                                        class="fas fa-solid fa-eye"></i></button>
                            </td>
                        </tr>
                        {%endfor%}

                    </tbody>
                </table>
            </div>
            <!-- /.card-body -->
        </div>
        <div class="" id="cont"></div>
        <script>
            $("#consultas button[name=detalle]").click(function () {
                id = $(this).val();
                $.ajax({
                    url: "/detalleconsul",
                    type: "POST",
                    data: {
                        id: id
                    },
                    success: function (response) {
                        $('#lista').hide();
                        $('#cont').html(response);
                        $('#cont').append(response.htmlresponse);
                        $('#launch').click();
                    },
                    error: function (error) {
                        //console.log(error);
                    },
                });
            });
        </script>
        {%else%}
        <!-- empleado -->
        <div class="top-bar"><i class="fas fa-bars menu"></i><label class="titulo-logo">Buen Productor > Agendar
                Consultas</label>
        </div>
        <div class="container bg-dark"
            style="color: white; margin-left: 80px !important; margin-top: 15px !important; height: 80vh; border-radius: 15px">
            <div class="row">
                <div class="col-4 overflow-auto" style="height: 100vh;">
                    <div class="row justify-content-center">CITA</div>

                    <div class="row mb-4">
                        <input type="hidden" name="id">
                        <div class="col mt-5">

                            <div class="form-group row">
                                <label for="inputPassword" class="col col-form-label">Cliente <i class="fas fa-plus"
                                        style="color: #999999;"></i></label>
                                <div class="col-sm-12">
                                    <input type="text" class="form-control" id="inputPassword" placeholder="Correo">
                                </div>
                            </div>

                        </div>

                    </div>
                    <div class="row mb-4">
                        <input type="hidden" name="id">
                        <div class="col">

                            <div class="form-group row">
                                <label for="inputPassword" class="col col-form-label">Mascota <i class="fas fa-plus"
                                        style="color: #999999;"></i></label>
                                <div class="col-sm-12 mr-2">
                                    <input type="text" class="form-control" id="inputPassword"
                                        placeholder="Nombre Mascota">
                                </div>
                            </div>

                        </div>

                    </div>
                    <div class="row mb-2">
                        <div class="col">
                            <div class="form-group row">
                                <label for="inputPassword" class="col-sm-2 col-form-label">Síntomas</label>
                                <div class="col-sm-12">
                                    <textarea type="text" class="form-control" cols="30" rows="10" id="inputPassword"
                                        placeholder="Descuento"></textarea>

                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="row  d-flex justify-content-center">
                        <input type="hidden" name="id">
                        <div class="col">
                            <label for="inputPassword" class="col col-form-label">Fecha</label>
                            <div class="col-sm-12 mr-2">
                                <input type="date" class="form-control" id="inputPassword" placeholder="Nombre Mascota">
                            </div>
                        </div>
                        <div class="col mt-4 text-center">
                            <button type="button" class="btn btn-outline-success btn-lg mt-3">Agendar</button>


                        </div>



                    </div>
                </div>
                <div class="col-8"
                    style="border: 1px solid white; background-color: rgb(182, 182, 182); height: 80vh; border-radius: 15px; overflow: hidden;">
                    <div id="calendario-cliente" style=" height: 80vh;">


                    </div>

                </div>
            </div>
        </div>
        <script>
            cale();
            function cale() {
                /* initialize the calendar
                 -----------------------------------------------------------------*/
                //Date for the calendar events (dummy data)
                var date1 = new Date()
                var d1 = date1.getDate(),
                    m1 = date1.getMonth(),
                    y1 = date1.getFullYear()

                var Calendar1 = FullCalendar.Calendar;
                var calendarEl1 = document.getElementById('calendario-cliente');

                // initialize the external events
                // -----------------------------------------------------------------
                var calendar1 = new Calendar1(calendarEl1, {

                    buttonText: {
                        prevYear: 'prev year',
                        nextYear: 'next year',
                        year: 'year',
                        today: 'Hoy',
                        month: 'Mes',
                        day: 'Dia',
                        list: 'list',
                    },
                    locale: 'es',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridDay'
                    },

                    //Random default events
                    events: [
                        {
                            title: 'Consulta 1',
                            start: new Date(y1, m1, 1),
                            backgroundColor: '#f56954', //red
                            borderColor: '#f56954', //red
                            allDay: true
                        }
                    ],
                    editable: false,


                });

                calendar1.render();
                // $('#calendario-cliente').fullCalendar()

            }
            var totalflag;
            var mascotaflag;
            var cambioDeus = function () {
                var correo = $('#correo').val();
                if (correo != "") {


                    $.ajax({
                        url: "/buscarcorreo",
                        type: "POST",
                        data: {
                            correo: correo,

                        },
                        success: function (response) {
                            if (response == "no existe") {
                                $('#form').show();
                                $('#mensaje_error_input_c').hide();
                                totalflag = 0;
                            } else {
                                $('#form').hide();
                                $('#mensaje_error_input_c').html("usuario encontrado ✓");
                                $('#mensaje_error_input_c').attr("class", "control-label col-md-12 text-success");
                                $('#mensaje_error_input_c').show();
                                $("#nombre").removeAttr("required");
                                $("#apellido").removeAttr("required");
                                $("#celular").removeAttr("required");
                                $("#telfijo").removeAttr("required");
                                $("#direccion").removeAttr("required");
                                $("#boton-enviar").removeAttr("disabled");
                                totalflag = 1;

                            }
                        },
                        error: function (error) {
                            //console.log(error);
                        },
                    });
                }

            }

            $("#correo").on('keyup', cambioDeus);
            var mascota = function () {
                var correo = $('#correo').val();
                var masc = $("#nombremas").val();

                $.ajax({
                    url: "/buscar",
                    type: "POST",
                    data: {
                        correo: correo,
                        masc: masc,
                        flag: "mascota",

                    },
                    success: function (response) {
                        if (response == "no") {
                            $('#formmas').show();
                            $('#mensaje_error_input_ma').hide();
                            mascotaflag = 0;
                        } else {
                            $('#formmas').hide();
                            $('#mensaje_error_input_ma').html("mascota encontrada ✓");
                            $('#mensaje_error_input_ma').attr("class", "control-label col-md-12 text-success");
                            $('#mensaje_error_input_ma').show();
                            $("#edad").removeAttr("required");
                            $("#raza").removeAttr("required");
                            mascotaflag = 1;

                        }
                    },
                    error: function (error) {
                        //console.log(error);
                    },
                });

            }

            $("#nombremas").on('keyup', mascota);

            function agendar() {
                var flag;
                var flag1;
                var flag2;
                if (($("#nombremas").val() == "" || $("#edad").val() == "" || $("#raza").val() == "") && mascotaflag == 0) {
                    $('#mensaje_error_input_m').hide();
                    bordeRojo($('#pet'));
                    $('#pet').addClass('animar');

                    setTimeout(function () {
                        $('#pet').removeClass('animar');
                    }, 1000)
                    flag = 0;
                } else {
                    $('#pet').css({ border: "1px solid green" });
                    flag = 1;

                }
                if ($('#sintomas1').val() == "" || $('#fecha').val() == "") {
                    bordeRojo($('#general'));
                    $('#general').addClass('animar');

                    setTimeout(function () {
                        $('#general').removeClass('animar');
                    }, 1000)
                    flag1 = 0;
                } else {
                    $('#general').css({ border: "1px solid green" });
                    flag1 = 1;

                }
                if (($('#correo').val() == "" || $('#nombre').val() == "" || $('#apellido').val() == "" || $('#celular').val() == "" || $('#telfijo').val() == "" || $('#direccion').val() == "") && totalflag == 0) {
                    bordeRojo($('#client'));
                    $('#client').addClass('animar');

                    setTimeout(function () {
                        $('#client').removeClass('animar');
                    }, 1000)
                    flag2 = 0;
                } else {
                    $('#client').css({ border: "1px solid green" });
                    flag2 = 1;
                }
                // el correo ya existe

                if (flag == 1 && flag1 == 1 && flag2 == 1 && totalflag == 1 && mascotaflag == 1) {

                    $.ajax({
                        url: "/mascota",
                        type: "POST",
                        data: {
                            nombremas: $('#nombremas').val(),
                            edad: $('#edad').val(),
                            tipo: $('#tipo').val(),
                            sexo: $('#sexo').val(),
                            raza: $('#raza').val(),
                            correo: $('#correo').val(),
                            flag: "vieja",

                        },
                        success: function (response) {
                            $.ajax({
                                url: "/generarconsulta",
                                type: "POST",
                                data: {
                                    nombremas: $('#nombremas').val(),
                                    correo: $('#correo').val(),
                                    sintomas1: $('#sintomas1').val(),
                                    fecha: $('#fecha').val(),

                                },
                                success: function (response) {
                                    Swal.fire({
                                        title: 'Cita Agendada Correctamente!',
                                        text: 'Gracias por preferirnos!!! ' + $('#correo').val(),
                                        icon: 'success',
                                        confirmButtonText: "Aceptar",
                                    }).then(() => {
                                        window.location = '../consulta'
                                    });

                                },
                                error: function (error) {
                                    //console.log(error);
                                },
                            });

                        },
                        error: function (error) {
                            //console.log(error);
                        },
                    });
                } else if (flag == 1 && flag1 == 1 && flag2 == 1 && totalflag == 1 && mascotaflag == 0) {
                    alert("mascota nuevo")
                    $.ajax({
                        url: "/mascota",
                        type: "POST",
                        data: {
                            nombremas: $('#nombremas').val(),
                            edad: $('#edad').val(),
                            tipo: $('#tipo').val(),
                            sexo: $('#sexo').val(),
                            raza: $('#raza').val(),
                            correo: $('#correo').val(),
                            flag: "",

                        },
                        success: function (response) {
                            $.ajax({
                                url: "/generarconsulta",
                                type: "POST",
                                data: {
                                    nombremas: $('#nombremas').val(),
                                    correo: $('#correo').val(),
                                    sintomas1: $('#sintomas1').val(),
                                    fecha: $('#fecha').val(),

                                },
                                success: function (response) {
                                    Swal.fire({
                                        title: 'Cita Agendada Correctamente!',
                                        text: 'Gracias por preferirnos!!! ' + $('#correo').val(),
                                        icon: 'success',
                                        confirmButtonText: "Aceptar",
                                    }).then(() => {
                                        window.location = '../consulta'
                                    });

                                },
                                error: function (error) {
                                    //console.log(error);
                                },
                            });

                        },
                        error: function (error) {
                            //console.log(error);
                        },
                    });
                }
                else if (flag == 1 && flag1 == 1 && flag2 == 1 && totalflag == 0 && mascotaflag == 0) {// el correo no existe y la mascota tampoco

                    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                    let result1 = '';
                    const charactersLength = characters.length;
                    for (let i = 0; i < 8; i++) {
                        result1 += characters.charAt(Math.floor(Math.random() * charactersLength));
                    }

                    var contra = result1;
                    var dato = $('#nombre').val();
                    // Usando replace y expresiones regulares
                    dato = dato.replace(/\s\s+/g, '').trim();
                    var array = new Array();
                    array = $.trim(dato).split(' ');
                    var usuario = array[0];
                    $.ajax({
                        url: "/nuevou",
                        type: "POST",
                        data: {
                            nombres: $('#nombre').val(),
                            apellidos: $('#apellido').val(),
                            correo: $('#correo').val(),
                            telefono: $('#telfijo').val(),
                            celular: $('#celular').val(),
                            direccion: $('#direccion').val(),
                            loginUser: usuario,
                            loginPassword: contra,
                            flag: "",
                        },
                        success: function (response) {
                            $.ajax({
                                url: "/correo",
                                type: "POST",
                                data: {
                                    nombres: $('#nombre').val(),
                                    apellidos: $('#apellido').val(),
                                    correo: $('#correo').val(),
                                    flag: "usuario",
                                    loginUser: usuario,
                                    loginPassword: contra,
                                },
                                success: function (response) {
                                    $.ajax({
                                        url: "/mascota",
                                        type: "POST",
                                        data: {
                                            nombremas: $('#nombremas').val(),
                                            edad: $('#edad').val(),
                                            tipo: $('#tipo').val(),
                                            sexo: $('#sexo').val(),
                                            raza: $('#raza').val(),
                                            correo: $('#correo').val(),
                                            flag: "",

                                        },
                                        success: function (response) {
                                            $.ajax({
                                                url: "/generarconsulta",
                                                type: "POST",
                                                data: {
                                                    nombremas: $('#nombremas').val(),
                                                    correo: $('#correo').val(),
                                                    sintomas1: $('#sintomas1').val(),
                                                    fecha: $('#fecha').val(),

                                                },
                                                success: function (response) {
                                                    Swal.fire({
                                                        title: 'Cita Agendada Correctamente!',
                                                        text: 'Se envio un correo con las credenciales al ' + $('#correo').val(),
                                                        icon: 'success',
                                                        confirmButtonText: "Aceptar",
                                                    }).then(() => {
                                                        window.location = '../consulta'
                                                    });

                                                },
                                                error: function (error) {
                                                    //console.log(error);
                                                },
                                            });

                                        },
                                        error: function (error) {
                                            //console.log(error);
                                        },
                                    });

                                },
                                error: function (error) {
                                    //console.log(error);
                                },
                            });
                        },
                        error: function (error) {
                            //console.log(error);
                        },
                    });
                }
            }





        </script>

        {%endif%}
        {%endblock%}
</body>


</html>